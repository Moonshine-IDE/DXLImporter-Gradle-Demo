plugins {
    id 'java'
    id 'application'  // allows 'run' task.
    id 'eclipse'      // allows dependencies to be exported to .classpath
}
mainClassName = 'net.prominic.demo.DemoJavaAgent'
repositories {
    mavenCentral()
}
sourceSets {
    main {
        java {
            srcDirs = ['src/main/java']
        }
    }
}

File importPropertiesDir = new File('agentProperties/')


// Required for Java 8 Language server support
sourceCompatibility = 1.8
targetCompatibility = 1.8

configurations {
	// custom environment for DXL Importer
	dxlRuntime.extendsFrom implementation  // TODO:  find a reference to the runtime classpath instead of implementation.  This is currently only needed for Notes.jar
}
dependencies {
    implementation files("${project.findProperty('notesInstallation')}/jvm/lib/ext/Notes.jar")

    // dependencies for importAgent
    // DXL Importer
    //dxlRuntime files('dxlLib/CheckDominoDesignElement.jar')
    dxlRuntime files('dxlLib/ImportDxlNsf.jar')
    
    // Dependencies for DXL Importer
    // TODO:  remove unnecessary jars after more testing
    //dxlRuntime 'ant-contrib:ant-contrib:1.0b3' //files('dxlLib/ant-contrib-0.6.jar')
    //dxlRuntime files('dxlLib/ant/ant-launcher.jar')
    //dxlRuntime files('dxlLib/ant/ant.jar')
    //dxlRuntime files('dxlLib/asm-all-5.0_BETA.jar')
    //dxlRuntime 'org.antlr:antlr-runtime:3.4' //files('dxlLib/svn/antlr-runtime-3.4.jar')
    //dxlRuntime files('dxlLib/svn/ganymed.jar')
    //dxlRuntime files('dxlLib/svn/jna.jar')
    //dxlRuntime files('dxlLib/svn/sequence-library-1.0.2.jar')
    //dxlRuntime files('dxlLib/svn/sqljet-1.1.10.jar')
    //dxlRuntime files('dxlLib/svn/sqljet-1.1.8-SNAPSHOT_r1300_v20130826_2110.jar')
    //dxlRuntime files('dxlLib/svn/svnClientAdapter.jar')
    //dxlRuntime files('dxlLib/svn/svnant.jar')
    //dxlRuntime files('dxlLib/svn/svnjavahl.jar')
    dxlRuntime 'org.tmatesoft.svnkit:svnkit:1.8.5' //files('dxlLib/svn/svnkit-1.8.5.jar')
    //dxlRuntime files('dxlLib/svn/svnkit-cli-1.8.5.jar')
    dxlRuntime files("${project.findProperty('notesInstallation')}/jvm/lib/ext/websvc.jar") //files('dxlLib/websvc.jar')
    //dxlRuntime files('dxlLib/xmltask.jar')

}

/**
 * Build the JAR for an individual agent, containing only the required classes.
 */
task jarDemoJavaAgent(type: Jar, dependsOn: classes) {
	// TODO: make this a parameter for reusability?
	String agentName = 'DemoJavaAgent'
	
	// Jar name - specify the full name for reference by DemoJavaAgent.properties
	archiveFileName = "${agentName}.jar"
	
	// Optional - only include the required class files
	from sourceSets.main.output // all class files and resources
	include ("**/${agentName}.class")
}

/**
 * Import an agent using ImportDxlNsf
 * TODO:  add parameters:
 *  - agentName
 *  - type?
 * TODO:  defaults and validation for server and dbname
 * TODO: remove this if ImportAgent works better
 */
task importAgent(type: JavaExec, dependsOn:  tasks.getByName('jarDemoJavaAgent')) {
    // Include all of the required JARs for ImportDxlNsf
    classpath = configurations.dxlRuntime
    //println configurations.dxlRuntime.asPath

    main = 'com.Prominic.ImportDxlNsfForStatic'  // deprecated in later versions of Gradle - use mainClass
    //mainClass = 'com.Prominic.ImportDxlNsfForStatic'

    // need to manually set DYLD_LIBRARY_PATH, since it will not be preserved in the environment
    environment('DYLD_LIBRARY_PATH', project.findProperty('notesInstallation')?:'')

    args '-a', 'agentProperties/agentbuild/DemoJavaAgent.properties', '-t', 'agent', '-sp', 'scriptLibraryConfig/ScriptLibraryConfig.properties', '-b', '.', '-s', project.findProperty('server')?:'', '-n', project.findProperty('dbName')?:''
}

/** 
 * Custom Task Type for DXL Importer.
 * Allows setting some of the JavaExec properties in a reusable task
 * I based this on: https://www.baeldung.com/gradle-custom-task
 */
class ImportAgent extends JavaExec {
	String propertiesFile
	
	public ImportAgent() {
		super()
		classpath = project.configurations.dxlRuntime
		main = 'com.Prominic.ImportDxlNsfForStatic'
		
		environment('DYLD_LIBRARY_PATH', project.findProperty('notesInstallation')?:'')
		// TODO:  update args when propertiesFile is updated
		
	}
	
	@TaskAction
	@Override
	void exec() {
		// set args here so that it can use the configured properties
		args '-a', propertiesFile?:'undefined', '-t', 'agent', '-sp', 'scriptLibraryConfig/ScriptLibraryConfig.properties', '-b', '.', '-s', project.findProperty('server')?:'', '-n', project.findProperty('dbName')?:'unknown.nsf'
		super.exec()
	}
}

task importAll() {
	// placeholder for dependencies generated by below code
}

// TODO: generate tasks for the script libraries

// generate tasks for agents
new File(importPropertiesDir, 'agentbuild').eachFile {File curFile ->
	String fullName = curFile.getName()
	int splitIndex = fullName.lastIndexOf('.')
	
	if (splitIndex >= 0) {  // .properties extension
		String extension = fullName.substring(splitIndex+1)
		String agentName = fullName.substring(0, splitIndex)
		
		if (extension.equalsIgnoreCase(extension)) {
			String importTaskName = "import$agentName"
			String jarTaskName = "jar$agentName"
			// if the custom jar task doesn't exist, default to base compile
			jarTaskName = tasks.findByName(jarTaskName) ? jarTaskName : 'jar'
			
			// don't override the existing task if it exists - allow this so that the user can define a custom override
			if (!tasks.findByName(importTaskName)) {
				tasks.create(name: importTaskName, type: ImportAgent, dependsOn: tasks.getByName(jarTaskName) ) {
					propertiesFile = curFile.getAbsolutePath()
				}
			}
			// else:  the task already exists
			
			// add a dependency on the importAll task
			tasks.getByName('importAll').dependsOn << importTaskName
			
		}
		else {
			println "Ignoring invalid property file:  ${curFile.getAbsolutePath()}"
		}
	}
}

